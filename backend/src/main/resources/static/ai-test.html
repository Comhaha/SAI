<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>AI í”¼ë“œë°± í…ŒìŠ¤íŠ¸</title>
  <style>
    body{font-family:system-ui,sans-serif;max-width:800px;margin:40px auto;padding:0 16px}
    h1{margin-top:0}
    textarea{width:100%;height:150px;margin-bottom:12px}
    input[type=file]{margin:8px 0 20px}
    input[type=text]{width:100%;padding:6px 8px;margin:6px 0 12px}
    #result{white-space:pre-wrap;border:1px solid #ccc;border-radius:4px;padding:12px}
    button{padding:8px 16px;margin-right:6px;font-size:16px;cursor:pointer}
  </style>
</head>
<body>
<h1>AI í”¼ë“œë°± ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸</h1>

<!-- ğŸ”‘ í† í° ì˜ì—­ -->
<label>API í† í°</label>
<input type="text" id="tokenInput" placeholder="ì—¬ê¸°ì— ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ë²„íŠ¼ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°">
<button id="getToken">í˜„ì¬ í† í° ê°€ì ¸ì˜¤ê¸°</button>

<hr>

<label>Python ì½”ë“œ</label>
<textarea id="code" placeholder="print(&quot;hello&quot;)"></textarea>

<label>í•™ìŠµ/ì‹¤í–‰ ë¡œê·¸</label>
<textarea id="log"  placeholder="Epoch 1/10 ..."></textarea>

<label>ì¶”ë¡  ê²°ê³¼ ì´ë¯¸ì§€ (PNG/JPEG, 4 MB ì´í•˜)</label><br>
<input type="file" id="img" accept="image/*">

<br>
<button id="run">í”¼ë“œë°± ìš”ì²­</button>

<h2>ê²°ê³¼</h2>
<div id="result"> </div>

<script>
  const $ = id => document.getElementById(id);
  const backend = location.origin;   // ê°™ì€ í˜¸ìŠ¤íŠ¸/í¬íŠ¸

  /* ---------- í† í° í•¨ìˆ˜ ---------- */

  // (A) /api/token â†’ í˜„ì¬ í† í° ê°€ì ¸ì˜¤ê¸°
  async function fetchTokenFromServer(){
    const res = await fetch(backend + "/api/token");
    if(!res.ok) throw new Error("HTTP "+res.status);
    const j = await res.json();
    return j.result.token;
  }

  // (B) ì…ë ¥ ì¹¸ì´ ë¹„ì–´ ìˆìœ¼ë©´ ì„œë²„ì—ì„œ ê°€ì ¸ì˜¤ê¸°
  async function resolveToken(){
    const manual = $("tokenInput").value.trim();
    return manual || fetchTokenFromServer();
  }

  /* ë²„íŠ¼: í˜„ì¬ í† í° ê°€ì ¸ì˜¤ê¸° */
  $("getToken").onclick = async ()=>{
    $("result").textContent = "â³ í† í° ê°€ì ¸ì˜¤ëŠ” ì¤‘â€¦";
    try{
      const t = await fetchTokenFromServer();
      $("tokenInput").value = t;
      $("result").textContent = "âœ… í† í° ì…ë ¥ë€ì— ì±„ì›Œì¡ŒìŠµë‹ˆë‹¤.";
    }catch(e){
      $("result").textContent = "âŒ í† í° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: " + e;
    }
  };

  /* ---------- Multipart FormData ---------- */
  function makeFormData(){
    const fd = new FormData();
    fd.append("code", $("code").value);
    fd.append("log",  $("log").value);
    const file = $("img").files[0];
    if(!file) throw new Error("ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”");
    fd.append("image", file);
    return fd;
  }

  /* ---------- í”¼ë“œë°± ìš”ì²­ ---------- */
  $("run").onclick = async ()=>{
    $("result").textContent = "â³ ìš”ì²­ ì¤‘â€¦";
    try{
      const token = await resolveToken();

      const res = await fetch(backend + "/api/ai/feedback",{
        method:"POST",
        headers:{ "Authorization": "Bearer " + token },
        body: makeFormData()
      });

      if(!res.ok){
        const txt = await res.text();
        throw new Error("HTTP "+res.status+" â€“ "+txt);
      }
      const js = await res.json();
      $("result").textContent = js.result?.feedback ?? "í”¼ë“œë°± í•„ë“œ ì—†ìŒ";
    }catch(e){
      $("result").textContent = "âŒ ì˜¤ë¥˜: " + e;
    }
  };
</script>
</body>
</html>
