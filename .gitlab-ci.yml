stages:
    - auto_mr

auto_merge_request:
    stage: auto_mr
    only:
        - branches
    script:
        - |
            Write-Host "ğŸ“„ ì»¤ë°‹ ë©”ì‹œì§€:"
            $commitMsg = git log -1 --pretty=%B
            $bodyOnly = ($commitMsg -split "`n" | Select-Object -Skip 1) -join "`n"

            Write-Host $bodyOnly

            if ($bodyOnly -notmatch '\[MR\]') {
              Write-Host "ğŸš« [MR] íƒœê·¸ ì—†ìŒ, MR ìƒì„± ìƒëµ"
              exit 0
            }

            Write-Host "âœ… [MR] íƒœê·¸ í™•ì¸ë¨. ê¸°ì¡´ MR í™•ì¸ ì¤‘..."

            $sourceBranch = "$env:CI_COMMIT_REF_NAME"
            $apiUrl = "$env:CI_API_V4_URL/projects/$env:CI_PROJECT_ID/merge_requests?source_branch=$sourceBranch"

            $existingMRs = Invoke-RestMethod -Headers @{ "PRIVATE-TOKEN" = "$env:CI_JOB_TOKEN" } -Uri $apiUrl -Method Get
            $openMR = $existingMRs | Where-Object { $_.state -eq "opened" }

            if ($openMR.Count -gt 0) {
              Write-Host "âš ï¸ ì´ë¯¸ ì—´ë¦° MRì´ ìˆìŒ â†’ ìƒˆë¡œ ë§Œë“¤ì§€ ì•ŠìŒ"
              exit 0
            }

            $createUrl = "$env:CI_API_V4_URL/projects/$env:CI_PROJECT_ID/merge_requests"
            Invoke-RestMethod -Headers @{ "PRIVATE-TOKEN" = "$env:CI_JOB_TOKEN" } -Uri $createUrl -Method Post -Form @{
              source_branch = $sourceBranch
              target_branch = "develop"
              title = "ìë™ MR: $sourceBranch"
              description = "ìë™ ìƒì„±ë¨"
            }

            Write-Host "âœ… MR ìƒì„± ì™„ë£Œ!"
