stages:
    - auto_mr

auto_merge_request:
    stage: auto_mr
    only:
        - branches
    script:
        - |
            Write-Host "ğŸ“„ ì»¤ë°‹ ë©”ì‹œì§€:"
            $commitMsg = git log -1 --pretty=%B
            $bodyOnly = ($commitMsg -split "`n" | Select-Object -Skip 1) -join "`n"

            Write-Host $bodyOnly

            if ($bodyOnly -notmatch '\[MR\]') {
              Write-Host "ğŸš« [MR] íƒœê·¸ ì—†ìŒ, MR ìƒì„± ìƒëµ"
              exit 0
            }

            Write-Host "âœ… [MR] íƒœê·¸ í™•ì¸ë¨. ê¸°ì¡´ MR í™•ì¸ ì¤‘..."

            # GitLab API í—¤ë”ì— Personal Access Token ì‚¬ìš©
            $headers = @{ "PRIVATE-TOKEN" = "$env:PERSONAL_TOKEN" }
            $sourceBranch = "$env:CI_COMMIT_REF_NAME"
            $projectId = "$env:CI_PROJECT_ID"
            $apiBase = "$($env:CI_API_V4_URL.TrimEnd('/'))/projects/$projectId/merge_requests"

            # source_branch ê¸°ì¤€ìœ¼ë¡œ ëª¨ë“  MR ê°€ì ¸ì˜¤ê¸°
            $allMRs = Invoke-RestMethod -Headers $headers -Uri "$apiBase?source_branch=$sourceBranch" -Method Get

            # ì—´ë¦° ìƒíƒœ(opened)ì¸ MRë§Œ í•„í„°ë§
            $openMR = $allMRs | Where-Object { $_.state -eq "opened" }

            if ($openMR.Count -gt 0) {
              Write-Host "âš ï¸ ì´ë¯¸ ì—´ë¦° MRì´ ìˆìŒ â†’ ìƒˆë¡œ ë§Œë“¤ì§€ ì•ŠìŒ"
              exit 0
            }

            Write-Host "ğŸš€ MR ìë™ ìƒì„± ì‹œì‘..."

            Invoke-RestMethod -Headers $headers -Uri $apiBase -Method Post -Form @{
              source_branch = $sourceBranch
              target_branch = "develop"
              title = "ìë™ MR: $sourceBranch"
              description = "ìë™ ìƒì„±ëœ Merge Requestì…ë‹ˆë‹¤. ì»¤ë°‹: $env:CI_COMMIT_SHORT_SHA"
            }

            Write-Host "âœ… MR ìƒì„± ì™„ë£Œ!"
