stages:
  - auto_mr

auto_merge_request:
  stage: auto_mr
  only:
    - branches
  script:
    - |
      echo "🔍 최신 커밋 메시지 읽는 중..."
      COMMIT_MSG=$(git log -1 --pretty=%B)
      BODY_ONLY=$(echo "$COMMIT_MSG" | tail -n +2)

      echo "📄 커밋 본문:"
      echo "$BODY_ONLY"

      # 본문에 [MR]이 없으면 종료
      if ! echo "$BODY_ONLY" | grep "\[MR\]"; then
        echo "🚫 [MR] 태그가 커밋 본문에 없습니다. MR 생성 생략."
        exit 0
      fi

      echo "✅ [MR] 태그 확인됨. 기존 MR 존재 여부 확인 중..."

      # 기존 열린 MR 확인
      SOURCE_BRANCH="$CI_COMMIT_REF_NAME"
      EXISTING_MR=$(curl --silent \
        --header "PRIVATE-TOKEN: $CI_JOB_TOKEN" \
        "$CI_API_V4_URL/projects/$CI_PROJECT_ID/merge_requests?state=opened&source_branch=$SOURCE_BRANCH")

      if [ "$EXISTING_MR" != "[]" ]; then
        echo "⚠️ 기존에 열린 MR이 존재합니다. 새로 만들지 않습니다."
        exit 0
      fi

      echo "🚀 MR 자동 생성 시작..."

      curl --request POST "$CI_API_V4_URL/projects/$CI_PROJECT_ID/merge_requests" \
        --header "PRIVATE-TOKEN: $CI_JOB_TOKEN" \
        --form "source_branch=$SOURCE_BRANCH" \
        --form "target_branch=develop" \
        --form "title=자동 MR: $SOURCE_BRANCH" \
        --form "description=이 커밋에서 자동 생성되었습니다: $CI_COMMIT_SHORT_SHA"

      echo "✅ MR 생성 완료!"
