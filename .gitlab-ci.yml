stages:
    - auto_mr

auto_merge_request:
    stage: auto_mr
    only:
        - branches
    script:
        - |
            Write-Host "ğŸ” ìµœì‹  ì»¤ë°‹ ë©”ì‹œì§€ ì½ëŠ” ì¤‘..."
            $COMMIT_MSG = git log -1 --pretty=%B
            $BODY_ONLY = $COMMIT_MSG -split "`n" | Select-Object -Skip 1

            Write-Host "ğŸ“„ ì»¤ë°‹ ë³¸ë¬¸:"
            Write-Host $BODY_ONLY

            # ë³¸ë¬¸ì— [MR]ì´ ì—†ìœ¼ë©´ ì¢…ë£Œ
            if (-not ($BODY_ONLY -match "\[MR\]")) {
              Write-Host "ğŸš« [MR] íƒœê·¸ê°€ ì»¤ë°‹ ë³¸ë¬¸ì— ì—†ìŠµë‹ˆë‹¤. MR ìƒì„± ìƒëµ."
              exit 0
            }

            Write-Host "âœ… [MR] íƒœê·¸ í™•ì¸ë¨. ê¸°ì¡´ MR ì¡´ì¬ ì—¬ë¶€ í™•ì¸ ì¤‘..."

            # ì—´ë¦° MRë§Œ í•„í„°ë§í•˜ë„ë¡ ì¡°íšŒ ë°©ì‹ ë³€ê²½
            $SOURCE_BRANCH = $env:CI_COMMIT_REF_NAME

            # GitLab API í—¤ë” ì„¤ì • - ê°œì¸ ì•¡ì„¸ìŠ¤ í† í° ì‚¬ìš©
            $headers = @{
                "PRIVATE-TOKEN" = $env:GITLAB_API_TOKEN  # CI/CD ë³€ìˆ˜ë¡œ ì„¤ì •ëœ ê°œì¸ ì•¡ì„¸ìŠ¤ í† í°
                "Content-Type" = "application/json"
            }

            try {
                $mrApiUrl = "$env:CI_API_V4_URL/projects/$env:CI_PROJECT_ID/merge_requests?source_branch=$SOURCE_BRANCH&state=opened"
                Write-Host "API URL: $mrApiUrl"
                
                $EXISTING_MR_ALL = Invoke-RestMethod -Uri $mrApiUrl -Headers $headers -Method Get
                
                if ($EXISTING_MR_ALL.Count -gt 0) {
                  Write-Host "âš ï¸ ê¸°ì¡´ì— ì—´ë¦° MRì´ ì¡´ì¬í•©ë‹ˆë‹¤. ìƒˆë¡œ ë§Œë“¤ì§€ ì•ŠìŠµë‹ˆë‹¤."
                  exit 0
                }

                Write-Host "ğŸš€ MR ìë™ ìƒì„± ì‹œì‘..."

                $MR_BODY = @{
                    source_branch = $SOURCE_BRANCH
                    target_branch = "develop"
                    title = "ìë™ MR: $SOURCE_BRANCH"
                    description = "ì´ ì»¤ë°‹ì—ì„œ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: $env:CI_COMMIT_SHORT_SHA"
                    remove_source_branch = $true
                } | ConvertTo-Json
                
                $createMrUrl = "$env:CI_API_V4_URL/projects/$env:CI_PROJECT_ID/merge_requests"
                Write-Host "Create MR URL: $createMrUrl"
                
                $response = Invoke-RestMethod -Uri $createMrUrl -Headers $headers -Method Post -Body $MR_BODY
                Write-Host "âœ… MR ìƒì„± ì™„ë£Œ! MR ë²ˆí˜¸: $($response.iid), ì œëª©: $($response.title)"
            }
            catch {
                Write-Host "âŒ ì—ëŸ¬ ë°œìƒ:"
                Write-Host $_.Exception.Message
                if ($_.ErrorDetails) {
                    Write-Host "ì‘ë‹µ ë³¸ë¬¸:"
                    Write-Host $_.ErrorDetails.Message
                }
                exit 1
            }
