stages:
    - auto_mr

auto_merge_request:
    stage: auto_mr
    only:
        - branches
    script:
        - |
            Write-Host "ğŸ” ìµœì‹  ì»¤ë°‹ ë©”ì‹œì§€ ì½ëŠ” ì¤‘..."
            $COMMIT_MSG = git log -1 --pretty=%B
            $BODY_ONLY = $COMMIT_MSG -split "`n" | Select-Object -Skip 1

            Write-Host "ğŸ“„ ì»¤ë°‹ ë³¸ë¬¸:"
            Write-Host $BODY_ONLY

            # ë³¸ë¬¸ì— [MR]ì´ ì—†ìœ¼ë©´ ì¢…ë£Œ
            if (-not ($BODY_ONLY -match "\[MR\]")) {
              Write-Host "ğŸš« [MR] íƒœê·¸ê°€ ì»¤ë°‹ ë³¸ë¬¸ì— ì—†ìŠµë‹ˆë‹¤. MR ìƒì„± ìƒëµ."
              exit 0
            }

            Write-Host "âœ… [MR] íƒœê·¸ í™•ì¸ë¨. ê¸°ì¡´ MR ì¡´ì¬ ì—¬ë¶€ í™•ì¸ ì¤‘..."

            # ì—´ë¦° MRë§Œ í•„í„°ë§í•˜ë„ë¡ ì¡°íšŒ ë°©ì‹ ë³€ê²½
            $SOURCE_BRANCH = $env:CI_COMMIT_REF_NAME
            $EXISTING_MR_ALL = Invoke-RestMethod -Uri "$env:CI_API_V4_URL/projects/$env:CI_PROJECT_ID/merge_requests?source_branch=$SOURCE_BRANCH" -Headers @{
                "PRIVATE-TOKEN" = $env:CI_JOB_TOKEN
            }

            # opened ìƒíƒœì¸ MR í™•ì¸
            $OPEN_MR = $EXISTING_MR_ALL | Where-Object { $_.state -eq "opened" }

            if ($OPEN_MR) {
              Write-Host "âš ï¸ ê¸°ì¡´ì— ì—´ë¦° MRì´ ì¡´ì¬í•©ë‹ˆë‹¤. ìƒˆë¡œ ë§Œë“¤ì§€ ì•ŠìŠµë‹ˆë‹¤."
              exit 0
            }

            Write-Host "ğŸš€ MR ìë™ ìƒì„± ì‹œì‘..."

            $MR_PARAMS = @{
                source_branch = $SOURCE_BRANCH
                target_branch = "develop"
                title = "ìë™ MR: $SOURCE_BRANCH"
                description = "ì´ ì»¤ë°‹ì—ì„œ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: $env:CI_COMMIT_SHORT_SHA"
            }

            Invoke-RestMethod -Method Post -Uri "$env:CI_API_V4_URL/projects/$env:CI_PROJECT_ID/merge_requests" -Headers @{
                "PRIVATE-TOKEN" = $env:CI_JOB_TOKEN
            } -Body $MR_PARAMS

            Write-Host "âœ… MR ìƒì„± ì™„ë£Œ!"
