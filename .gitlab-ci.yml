stages:
    - auto_mr

auto_merge_request:
    stage: auto_mr
    only:
        - branches
    script:
        - |
            Write-Host "📄 커밋 메시지:"
            $commitMsg = git log -1 --pretty=%B
            $bodyOnly = ($commitMsg -split "`n" | Select-Object -Skip 1) -join "`n"

            Write-Host $bodyOnly

            if ($bodyOnly -notmatch '\[MR\]') {
              Write-Host "🚫 [MR] 태그 없음, MR 생성 생략"
              exit 0
            }

            Write-Host "✅ [MR] 태그 확인됨. 기존 MR 확인 중..."

            $sourceBranch = "$env:CI_COMMIT_REF_NAME"
            $apiUrl = "$env:CI_API_V4_URL/projects/$env:CI_PROJECT_ID/merge_requests?source_branch=$sourceBranch"

            $existingMRs = Invoke-RestMethod -Headers @{ "PRIVATE-TOKEN" = "$env:CI_JOB_TOKEN" } -Uri $apiUrl -Method Get
            $openMR = $existingMRs | Where-Object { $_.state -eq "opened" }

            if ($openMR.Count -gt 0) {
              Write-Host "⚠️ 이미 열린 MR이 있음 → 새로 만들지 않음"
              exit 0
            }

            $createUrl = "$env:CI_API_V4_URL/projects/$env:CI_PROJECT_ID/merge_requests"
            Invoke-RestMethod -Headers @{ "PRIVATE-TOKEN" = "$env:CI_JOB_TOKEN" } -Uri $createUrl -Method Post -Form @{
              source_branch = $sourceBranch
              target_branch = "develop"
              title = "자동 MR: $sourceBranch"
              description = "자동 생성됨"
            }

            Write-Host "✅ MR 생성 완료!"
