stages:
  - auto_mr

auto_merge_request:
  stage: auto_mr
  only:
    - branches
  script:
    - |
      echo "ğŸ” ìµœì‹  ì»¤ë°‹ ë©”ì‹œì§€ ì½ëŠ” ì¤‘..."
      COMMIT_MSG=$(git log -1 --pretty=%B)
      BODY_ONLY=$(echo "$COMMIT_MSG" | tail -n +2)

      echo "ğŸ“„ ì»¤ë°‹ ë³¸ë¬¸:"
      echo "$BODY_ONLY"

      # ë³¸ë¬¸ì— [MR]ì´ ì—†ìœ¼ë©´ ì¢…ë£Œ
      if ! echo "$BODY_ONLY" | grep "\[MR\]"; then
        echo "ğŸš« [MR] íƒœê·¸ê°€ ì»¤ë°‹ ë³¸ë¬¸ì— ì—†ìŠµë‹ˆë‹¤. MR ìƒì„± ìƒëµ."
        exit 0
      fi

      echo "âœ… [MR] íƒœê·¸ í™•ì¸ë¨. ê¸°ì¡´ MR ì¡´ì¬ ì—¬ë¶€ í™•ì¸ ì¤‘..."

      # ê¸°ì¡´ ì—´ë¦° MR í™•ì¸
      SOURCE_BRANCH="$CI_COMMIT_REF_NAME"
      EXISTING_MR=$(curl --silent \
        --header "PRIVATE-TOKEN: $CI_JOB_TOKEN" \
        "$CI_API_V4_URL/projects/$CI_PROJECT_ID/merge_requests?state=opened&source_branch=$SOURCE_BRANCH")

      if [ "$EXISTING_MR" != "[]" ]; then
        echo "âš ï¸ ê¸°ì¡´ì— ì—´ë¦° MRì´ ì¡´ì¬í•©ë‹ˆë‹¤. ìƒˆë¡œ ë§Œë“¤ì§€ ì•ŠìŠµë‹ˆë‹¤."
        exit 0
      fi

      echo "ğŸš€ MR ìë™ ìƒì„± ì‹œì‘..."

      curl --request POST "$CI_API_V4_URL/projects/$CI_PROJECT_ID/merge_requests" \
        --header "PRIVATE-TOKEN: $CI_JOB_TOKEN" \
        --form "source_branch=$SOURCE_BRANCH" \
        --form "target_branch=develop" \
        --form "title=ìë™ MR: $SOURCE_BRANCH" \
        --form "description=ì´ ì»¤ë°‹ì—ì„œ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: $CI_COMMIT_SHORT_SHA"

      echo "âœ… MR ìƒì„± ì™„ë£Œ!"
